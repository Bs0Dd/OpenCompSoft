--[[NyaDraw Graphic Engine v1.06 for OpenOS (Minified version)
	Standalone "Screen.lua" port from MineOS
	More info on: https://github.com/Bs0Dd/OpenCompSoft/blob/master/NyaDraw/README.md
	2015-2021 - ECS: https://github.com/IgorTimofeev
	2021 - Bs0Dd: https://github.com/Bs0Dd
]]
local a=require("unicode")local b=require("computer")local c=require("bit32")local d,e;local f,g,h,i,j,k;local l,m,n,o;local p,q,r,s,t,u,v,w,x,y;local z,A,B,C=math.ceil,math.floor,math.modf,math.abs;local D,E=table.insert,table.concat;local F;local G,H=a.len,a.sub;local function I(J,K)return d*(K-1)+J end;local function L()return f,g,h end;local function M()return i,j,k end;local function N(O,P,Q,R)l,n,m,o=O,P,Q,R end;local function S()l,n,m,o=1,1,d,e end;local function T()return l,n,m,o end;local U={0x000000,0x000040,0x000080,0x0000BF,0x0000FF,0x002400,0x002440,0x002480,0x0024BF,0x0024FF,0x004900,0x004940,0x004980,0x0049BF,0x0049FF,0x006D00,0x006D40,0x006D80,0x006DBF,0x006DFF,0x009200,0x009240,0x009280,0x0092BF,0x0092FF,0x00B600,0x00B640,0x00B680,0x00B6BF,0x00B6FF,0x00DB00,0x00DB40,0x00DB80,0x00DBBF,0x00DBFF,0x00FF00,0x00FF40,0x00FF80,0x00FFBF,0x00FFFF,0x0F0F0F,0x1E1E1E,0x2D2D2D,0x330000,0x330040,0x330080,0x3300BF,0x3300FF,0x332400,0x332440,0x332480,0x3324BF,0x3324FF,0x334900,0x334940,0x334980,0x3349BF,0x3349FF,0x336D00,0x336D40,0x336D80,0x336DBF,0x336DFF,0x339200,0x339240,0x339280,0x3392BF,0x3392FF,0x33B600,0x33B640,0x33B680,0x33B6BF,0x33B6FF,0x33DB00,0x33DB40,0x33DB80,0x33DBBF,0x33DBFF,0x33FF00,0x33FF40,0x33FF80,0x33FFBF,0x33FFFF,0x3C3C3C,0x4B4B4B,0x5A5A5A,0x660000,0x660040,0x660080,0x6600BF,0x6600FF,0x662400,0x662440,0x662480,0x6624BF,0x6624FF,0x664900,0x664940,0x664980,0x6649BF,0x6649FF,0x666D00,0x666D40,0x666D80,0x666DBF,0x666DFF,0x669200,0x669240,0x669280,0x6692BF,0x6692FF,0x66B600,0x66B640,0x66B680,0x66B6BF,0x66B6FF,0x66DB00,0x66DB40,0x66DB80,0x66DBBF,0x66DBFF,0x66FF00,0x66FF40,0x66FF80,0x66FFBF,0x66FFFF,0x696969,0x787878,0x878787,0x969696,0x990000,0x990040,0x990080,0x9900BF,0x9900FF,0x992400,0x992440,0x992480,0x9924BF,0x9924FF,0x994900,0x994940,0x994980,0x9949BF,0x9949FF,0x996D00,0x996D40,0x996D80,0x996DBF,0x996DFF,0x999200,0x999240,0x999280,0x9992BF,0x9992FF,0x99B600,0x99B640,0x99B680,0x99B6BF,0x99B6FF,0x99DB00,0x99DB40,0x99DB80,0x99DBBF,0x99DBFF,0x99FF00,0x99FF40,0x99FF80,0x99FFBF,0x99FFFF,0xA5A5A5,0xB4B4B4,0xC3C3C3,0xCC0000,0xCC0040,0xCC0080,0xCC00BF,0xCC00FF,0xCC2400,0xCC2440,0xCC2480,0xCC24BF,0xCC24FF,0xCC4900,0xCC4940,0xCC4980,0xCC49BF,0xCC49FF,0xCC6D00,0xCC6D40,0xCC6D80,0xCC6DBF,0xCC6DFF,0xCC9200,0xCC9240,0xCC9280,0xCC92BF,0xCC92FF,0xCCB600,0xCCB640,0xCCB680,0xCCB6BF,0xCCB6FF,0xCCDB00,0xCCDB40,0xCCDB80,0xCCDBBF,0xCCDBFF,0xCCFF00,0xCCFF40,0xCCFF80,0xCCFFBF,0xCCFFFF,0xD2D2D2,0xE1E1E1,0xF0F0F0,0xFF0000,0xFF0040,0xFF0080,0xFF00BF,0xFF00FF,0xFF2400,0xFF2440,0xFF2480,0xFF24BF,0xFF24FF,0xFF4900,0xFF4940,0xFF4980,0xFF49BF,0xFF49FF,0xFF6D00,0xFF6D40,0xFF6D80,0xFF6DBF,0xFF6DFF,0xFF9200,0xFF9240,0xFF9280,0xFF92BF,0xFF92FF,0xFFB600,0xFFB640,0xFFB680,0xFFB6BF,0xFFB6FF,0xFFDB00,0xFFDB40,0xFFDB80,0xFFDBBF,0xFFDBFF,0xFFFF00,0xFFFF40,0xFFFF80,0xFFFFBF,0xFFFFFF}local function V(W)return U[W+1]end;if b.getArchitecture and b.getArchitecture()=="Lua 5.3"then F=load("return function(a,b,c)local d=1-c return((b>>16)*d+(a>>16)*c)//1<<16|((b>>8&0xFF)*d+(a>>8&0xFF)*c)//1<<8|((b&0xFF)*d+(a&0xFF)*c)//1 end")()else F=function(X,Y,Z)local _=1-Z;local a0,a1=X/65536,Y/65536;a0,a1=a0-a0%1,a1-a1%1;local a2,a3=(X-a0*65536)/256,(Y-a1*65536)/256;a2,a3=a2-a2%1,a3-a3%1;local a4,a5,a6=a1*_+a0*Z,a3*_+a2*Z,(Y-a1*65536-a3*256)*_+(X-a0*65536-a2*256)*Z;return(a4-a4%1)*65536+(a5-a5%1)*256+a6-a6%1 end end;local function a7(a8,a9,...)local aa=a8;local ab=table.pack(...)for ac=1,ab.n do aa=a9(aa,ab[ac])end;return aa end;local function ad(ae)local af={string.byte(ae:read(1))}local ag=0;for ac=1,7 do if c.band(c.rshift(af[1],8-ac),0x1)==0x0 then ag=ac;break end end;for ac=1,ag-2 do table.insert(af,string.byte(ae:read(1)))end;return string.char(table.unpack(af))end;local function ah(ae,ai)local aj,aa={string.byte(ae:read(ai)or"\x00",1,8)},0;for ac=1,#aj do aa=c.bor(c.lshift(aa,8),aj[ac])end;return aa end;local function ak(al,J,K,am,an,ao,ap)local aq=4*(al[1]*(K-1)+J)-1;al[aq],al[aq+1],al[aq+2],al[aq+3]=am,an,ao,ap;return al end;local function ar(ae,al,as)al[1]=string.byte(ae:read(1))al[2]=string.byte(ae:read(1))local at,au,av,aw,ax;for ao=1,string.byte(ae:read(1))+as do at=string.byte(ae:read(1))/255;for ap=1,ah(ae,2)+as do au=ad(ae)for am=1,string.byte(ae:read(1))+as do av=V(string.byte(ae:read(1)))for an=1,string.byte(ae:read(1))+as do aw=V(string.byte(ae:read(1)))for K=1,string.byte(ae:read(1))+as do ax=string.byte(ae:read(1))for J=1,string.byte(ae:read(1))+as do ak(al,string.byte(ae:read(1)),ax,av,aw,at,au)end end end end end end end;local ay={}ay[5]=function(ae,al)al[1]=ah(ae,2)al[2]=ah(ae,2)for ac=1,al[1]*al[2]do table.insert(al,V(string.byte(ae:read(1))))table.insert(al,V(string.byte(ae:read(1))))table.insert(al,string.byte(ae:read(1))/255)table.insert(al,ad(ae))end end;ay[6]=function(ae,al)ar(ae,al,0)end;ay[7]=function(ae,al)ar(ae,al,1)end;local function az(aA)local ae,aB=io.open(aA,"rb")if ae then local aC=ae:read(4)if aC=="OCIF"then local aD=string.byte(ae:read(1))if ay[aD]then local al={}local aa,aB=xpcall(ay[aD],debug.traceback,ae,al)ae:close()if aa then return al else return false,"Failed to load OCIF image: "..tostring(aB)end else ae:close()return false,"Failed to load OCIF image: encoding method \""..tostring(aD).."\" is not supported"end else ae:close()return false,"Failed to load OCIF image: binary signature \""..tostring(aC).."\" is not valid"end else return false,"Failed to open file \""..tostring(aA).."\" for reading: "..tostring(aB)end end;local function aE(aF,aG)if not aF or not aG then aF,aG=q()end;f,g,h,i,j,k={},{},{},{},{},{}d=aF;e=aG;S()for K=1,e do for J=1,d do D(f,0x010101)D(g,0xFEFEFE)D(h," ")D(i,0x010101)D(j,0xFEFEFE)D(k," ")end end end;local function aH(aF,aG)r(aF,aG)aE(aF,aG)end;local function aI()return d,e end;local function aJ()return d end;local function aK()return e end;local function aL(aM,aN)local aO,aB=p.bind(aM,aN)if aO then if aN then aH(p.maxResolution())else aH(d,e)end else return aO,aB end end;local function aP()return p end;local function aQ()w=p.get;q=p.getResolution;s=p.getBackground;t=p.getForeground;x=p.set;r=p.setResolution;u=p.setBackground;v=p.setForeground;y=p.fill end;local function aR(aS)p=aS;aQ()aE()end;local function aT(aU)if not aU or aU>1 then aU=1 elseif aU<0.1 then aU=0.1 end;local aV,aW=component.proxy(p.getScreen()).getAspectRatio()local aX,aY=p.maxResolution()local aZ=2*(16*aV-4.5)/(16*aW-4.5)local aG=aU*math.min(aX/aZ,aX,math.sqrt(aX*aY/aZ))return math.floor(aG*aZ),math.floor(aG)end;local function a_(aq,am,an,ap)i[aq],j[aq],k[aq]=am,an,ap end;local function b0(aq)return i[aq],j[aq],k[aq]end;local function b1(J,K)if J>=1 and K>=1 and J<=d and K<=e then local aq=d*(K-1)+J;return i[aq],j[aq],k[aq]else return 0x000000,0x000000," "end end;local function b2(J,K,am,an,ap)if J>=l and K>=n and J<=m and K<=o then local aq=d*(K-1)+J;i[aq],j[aq],k[aq]=am,an,ap end end;local function b3(J,K,aF,aG,am,an,ap,Z)local aq,b4=d*(K-1)+J,d-aF;for b5=K,K+aG-1 do if b5>=n and b5<=o then for ac=J,J+aF-1 do if ac>=l and ac<=m then if Z then i[aq],j[aq]=F(i[aq],am,Z),F(j[aq],am,Z)else i[aq],j[aq],k[aq]=am,an,ap end end;aq=aq+1 end;aq=aq+b4 else aq=aq+d end end end;local function b6(b7,Z)b3(1,1,d,e,b7 or 0x0,0x000000," ",Z)end;local function b8(J,K,aF,aG)local b9,aq={aF,aG}for b5=K,K+aG-1 do for ac=J,J+aF-1 do if ac>=1 and b5>=1 and ac<=d and b5<=e then aq=d*(b5-1)+ac;D(b9,i[aq])D(b9,j[aq])D(b9,k[aq])else D(b9,0x0)D(b9,0x0)D(b9," ")end end end;return b9 end;local function ba(bb,bc,al)local bd=al[1]local be,bf,bg=d*(bc-1)+bb,3,d-bd;for K=bc,bc+al[2]-1 do if K>=n and K<=o then for J=bb,bb+bd-1 do if J>=l and J<=m then i[be]=al[bf]j[be]=al[bf+1]k[be]=al[bf+2]end;be,bf=be+1,bf+3 end;be=be+bg else be,bf=be+d,bf+bd*3 end end end;local function bh(O,P,Q,R,bi)local bj,bk,bl,bm,bn,bo,bp=O,Q,P,R,false,C(Q-O),C(R-P)if bo<bp then bj,bk,bl,bm,bn,bo,bp=P,R,O,Q,true,bp,bo end;if bl>bm then bl,bm=bm,bl;bj,bk=bk,bj end;local bq,br,bs=bl,1,bo/bp;local bt=bs;for bu=bj,bk,bj<bk and 1 or-1 do if bn then bi(bq,bu)else bi(bu,bq)end;br=br+1;if br>bt then bq,bt=bq+1,bt+bs end end end;local function bv(bw,bx,by,bz,bi)local function bA(bB,bC)bi(bw+bB,bx+bC)bi(bw-bB,bx+bC)bi(bw-bB,bx-bC)bi(bw+bB,bx-bC)end;local J,K,bD,bE,bF,bG,bH=by,0,bz*bz*(1-2*by),by*by,0,2*by*by,2*bz*bz;local bI,bJ=bH*by,0;while bI>=bJ do bA(J,K)K,bJ,bF=K+1,bJ+bG,bF+bE;bE=bE+bG;if 2*bF+bD>0 then J,bI,bF=J-1,bI-bH,bF+bD;bD=bD+bH end end;J,K,bD,bE,bF,bI,bJ=0,bz,bz*bz,by*by*(1-2*bz),0,0,bG*bz;while bI<=bJ do bA(J,K)J,bI,bF=J+1,bI+bH,bF+bD;bD=bD+bH;if 2*bF+bE>0 then K,bJ,bF=K-1,bJ-bG,bF+bE;bE=bE+bG end end end;local function bK(O,P,Q,R,am,an,ap)bh(O,P,Q,R,function(J,K)b2(J,K,am,an,ap)end)end;local function bL(bw,bx,by,bz,am,an,ap)bv(bw,bx,by,bz,function(J,K)b2(J,K,am,an,ap)end)end;local function bM(J,K,bN,bO,Z)if K>=n and K<=o then local bP,be=1,d*(K-1)+J;for bP=1,G(bO)do if J>=l and J<=m then if Z then j[be]=F(i[be],bN,Z)else j[be]=bN end;k[be]=H(bO,bP,bP)end;J,be=J+1,be+1 end end end;local function bQ(bb,bc,al,bR)local be,bf,bd,am,an,ao,ap=d*(bc-1)+bb,3,al[1]local bg=d-bd;for K=bc,bc+al[2]-1 do if K>=n and K<=o then for J=bb,bb+bd-1 do if J>=l and J<=m then ao,ap=al[bf+2],al[bf+3]if ao==0 then i[be],j[be]=al[bf],al[bf+1]elseif ao>0 and ao<1 then i[be]=F(i[be],al[bf],ao)if bR then j[be]=F(j[be],al[bf+1],ao)else j[be]=al[bf+1]end elseif ap~=" "then j[be]=al[bf+1]end;k[be]=ap end;be,bf=be+1,bf+4 end;be=be+bg else be,bf=be+d,bf+bd*4 end end end;local function bS(J,K,aF,aG,b7)local bT,bU,Q="┌"..string.rep("─",aF-2).."┐","└"..string.rep("─",aF-2).."┘",J+aF-1;bM(J,K,b7,bT)K=K+1;for ac=1,aG-2 do bM(J,K,b7,"│")bM(Q,K,b7,"│")K=K+1 end;bM(J,K,b7,bU)end;local function bV(aq,b7,bW)local bX,bY,bZ="▀","▄"," "local am,an,ap=i[aq],j[aq],k[aq]if bW then if ap==bX then if b7==an then i[aq],j[aq],k[aq]=b7,an,bZ else i[aq],j[aq],k[aq]=b7,an,ap end elseif ap==bZ then if b7~=am then i[aq],j[aq],k[aq]=am,b7,bY end else i[aq],j[aq],k[aq]=am,b7,bY end else if ap==bY then if b7==an then i[aq],j[aq],k[aq]=b7,an,bZ else i[aq],j[aq],k[aq]=b7,an,ap end elseif ap==bZ then if b7~=am then i[aq],j[aq],k[aq]=am,b7,bX end else i[aq],j[aq],k[aq]=am,b7,bX end end end;local function b_(J,K,b7)local c0=z(K/2)if J>=l and c0>=n and J<=m and c0<=o then bV(d*(c0-1)+J,b7,K%2==0)end end;local function c1(J,K,aF,aG,b7)local aq,c2,c3,c4,c5=d*(z(K/2)-1)+J,d-aF,aF;for c6=K,K+aG-1 do c4=z(c6/2)if c4>=n and c4<=o then c5=c6%2==0;for c7=J,J+aF-1 do if c7>=l and c7<=m then bV(aq,b7,c5)end;aq=aq+1 end else aq=aq+aF end;if c5 then aq=aq+c2 else aq=aq-c3 end end end;local function c8(O,P,Q,R,b7)bh(O,P,Q,R,function(J,K)b_(J,K,b7)end)end;local function c9(bw,bx,by,bz,b7)bv(bw,bx,by,bz,function(J,K)b_(J,K,b7)end)end;local function ca(cb,cc,cd)return{x=cb.x+(cc.x-cb.x)*cd,y=cb.y+(cc.y-cb.y)*cd}end;local function ce(cf,cd)local cg={}for ch=1,#cf-1 do D(cg,ca(cf[ch],cf[ch+1],cd))end;return cg end;local function ci(cf,cd)if#cf>1 then return ci(ce(cf,cd),cd)else return cf[1]end end;local function cj(cf,b7,ck)local cl={}for cd=0,1,ck or 0.01 do D(cl,ci(cf,cd))end;for ch=1,#cl-1 do c8(A(cl[ch].x),A(cl[ch].y),A(cl[ch+1].x),A(cl[ch+1].y),b7)end end;local function cm(cn)local aq,co,cp=d*(n-1)+l,d-m+l-1,{}local J,cq,cr,cs,bP,aw;local ct,cu,cv,cw,cx;local cy;for K=n,o do J=l;while J<=m do if f[aq]~=i[aq]or g[aq]~=j[aq]or h[aq]~=k[aq]or cn then ct,cu,cv=i[aq],j[aq],k[aq]f[aq]=ct;g[aq]=cu;h[aq]=cv;cq,cr,cs,bP={cv},2,J+1,aq+1;while cs<=m do if ct==i[bP]and(k[bP]==" "or cu==j[bP])then f[bP]=i[bP]g[bP]=j[bP]h[bP]=k[bP]cq[cr],cr=h[bP],cr+1 else break end;cs,bP=cs+1,bP+1 end;cp[ct]=cp[ct]or{}cw=cp[ct]cw[cu]=cw[cu]or{index=1}cx=cw[cu]cy=cx.index;cx[cy],cy=J,cy+1;cx[cy],cy=K,cy+1;cx[cy],cy=E(cq),cy+1;J,aq,cx.index=J+cr-2,aq+cr-2,cy end;J,aq=J+1,aq+1 end;aq=aq+co end;for am,cz in pairs(cp)do u(am)for an,cA in pairs(cz)do if aw~=an then v(an)aw=an end;for ac=1,#cA,3 do x(cA[ac],cA[ac+1],cA[ac+2])end end end;cp=nil end;return{loadImage=az,getIndex=I,setDrawLimit=N,resetDrawLimit=S,getDrawLimit=T,flush=aE,setResolution=aH,bind=aL,setGPUProxy=aR,getGPUProxy=aP,getScaledResolution=aT,getResolution=aI,getWidth=aJ,getHeight=aK,getCurrentFrameTables=L,getNewFrameTables=M,rawSet=a_,rawGet=b0,get=b1,set=b2,clear=b6,copy=b8,paste=ba,rasterizeLine=bh,rasterizeEllipse=bv,semiPixelRawSet=bV,semiPixelSet=b_,update=cm,drawRectangle=b3,drawLine=bK,drawEllipse=bL,drawText=bM,drawImage=bQ,drawFrame=bS,drawSemiPixelRectangle=c1,drawSemiPixelLine=c8,drawSemiPixelEllipse=c9,drawSemiPixelCurve=cj}