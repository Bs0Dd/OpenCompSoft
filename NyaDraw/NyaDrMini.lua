--[[NyaDraw Graphic Engine v1.04 for OpenOS (Minified version)
	Standalone "Screen.lua" port from MineOS
	More info on: https://github.com/Bs0Dd/OpenCompSoft/blob/master/NyaDraw/README.md
	2015-2021 - ECS: https://github.com/IgorTimofeev
	2021 - Bs0Dd: https://github.com/Bs0Dd
]]
local a=require("unicode")local b=require("computer")local c,d;local e,f,g,h,i,j;local k,l,m,n;local o,p,q,r,s,t,u,v,w,x;local y,z,A,B=math.ceil,math.floor,math.modf,math.abs;local C,D=table.insert,table.concat;local E;local F,G=a.len,a.sub;local function H(I,J)return c*(J-1)+I end;local function K()return e,f,g end;local function L()return h,i,j end;local function M(N,O,P,Q)k,m,l,n=N,O,P,Q end;local function R()k,m,l,n=1,1,c,d end;local function S()return k,m,l,n end;local T={0x000000,0x000040,0x000080,0x0000BF,0x0000FF,0x002400,0x002440,0x002480,0x0024BF,0x0024FF,0x004900,0x004940,0x004980,0x0049BF,0x0049FF,0x006D00,0x006D40,0x006D80,0x006DBF,0x006DFF,0x009200,0x009240,0x009280,0x0092BF,0x0092FF,0x00B600,0x00B640,0x00B680,0x00B6BF,0x00B6FF,0x00DB00,0x00DB40,0x00DB80,0x00DBBF,0x00DBFF,0x00FF00,0x00FF40,0x00FF80,0x00FFBF,0x00FFFF,0x0F0F0F,0x1E1E1E,0x2D2D2D,0x330000,0x330040,0x330080,0x3300BF,0x3300FF,0x332400,0x332440,0x332480,0x3324BF,0x3324FF,0x334900,0x334940,0x334980,0x3349BF,0x3349FF,0x336D00,0x336D40,0x336D80,0x336DBF,0x336DFF,0x339200,0x339240,0x339280,0x3392BF,0x3392FF,0x33B600,0x33B640,0x33B680,0x33B6BF,0x33B6FF,0x33DB00,0x33DB40,0x33DB80,0x33DBBF,0x33DBFF,0x33FF00,0x33FF40,0x33FF80,0x33FFBF,0x33FFFF,0x3C3C3C,0x4B4B4B,0x5A5A5A,0x660000,0x660040,0x660080,0x6600BF,0x6600FF,0x662400,0x662440,0x662480,0x6624BF,0x6624FF,0x664900,0x664940,0x664980,0x6649BF,0x6649FF,0x666D00,0x666D40,0x666D80,0x666DBF,0x666DFF,0x669200,0x669240,0x669280,0x6692BF,0x6692FF,0x66B600,0x66B640,0x66B680,0x66B6BF,0x66B6FF,0x66DB00,0x66DB40,0x66DB80,0x66DBBF,0x66DBFF,0x66FF00,0x66FF40,0x66FF80,0x66FFBF,0x66FFFF,0x696969,0x787878,0x878787,0x969696,0x990000,0x990040,0x990080,0x9900BF,0x9900FF,0x992400,0x992440,0x992480,0x9924BF,0x9924FF,0x994900,0x994940,0x994980,0x9949BF,0x9949FF,0x996D00,0x996D40,0x996D80,0x996DBF,0x996DFF,0x999200,0x999240,0x999280,0x9992BF,0x9992FF,0x99B600,0x99B640,0x99B680,0x99B6BF,0x99B6FF,0x99DB00,0x99DB40,0x99DB80,0x99DBBF,0x99DBFF,0x99FF00,0x99FF40,0x99FF80,0x99FFBF,0x99FFFF,0xA5A5A5,0xB4B4B4,0xC3C3C3,0xCC0000,0xCC0040,0xCC0080,0xCC00BF,0xCC00FF,0xCC2400,0xCC2440,0xCC2480,0xCC24BF,0xCC24FF,0xCC4900,0xCC4940,0xCC4980,0xCC49BF,0xCC49FF,0xCC6D00,0xCC6D40,0xCC6D80,0xCC6DBF,0xCC6DFF,0xCC9200,0xCC9240,0xCC9280,0xCC92BF,0xCC92FF,0xCCB600,0xCCB640,0xCCB680,0xCCB6BF,0xCCB6FF,0xCCDB00,0xCCDB40,0xCCDB80,0xCCDBBF,0xCCDBFF,0xCCFF00,0xCCFF40,0xCCFF80,0xCCFFBF,0xCCFFFF,0xD2D2D2,0xE1E1E1,0xF0F0F0,0xFF0000,0xFF0040,0xFF0080,0xFF00BF,0xFF00FF,0xFF2400,0xFF2440,0xFF2480,0xFF24BF,0xFF24FF,0xFF4900,0xFF4940,0xFF4980,0xFF49BF,0xFF49FF,0xFF6D00,0xFF6D40,0xFF6D80,0xFF6DBF,0xFF6DFF,0xFF9200,0xFF9240,0xFF9280,0xFF92BF,0xFF92FF,0xFFB600,0xFFB640,0xFFB680,0xFFB6BF,0xFFB6FF,0xFFDB00,0xFFDB40,0xFFDB80,0xFFDBBF,0xFFDBFF,0xFFFF00,0xFFFF40,0xFFFF80,0xFFFFBF,0xFFFFFF}local function U(V)return T[V+1]end;if b.getArchitecture and b.getArchitecture()=="Lua 5.3"then E=load([[return function(color1, color2, transparency) local invertedTransparency = 1 - transparency return ((color2 >> 16) * invertedTransparency + (color1 >> 16) * transparency) // 1 << 16 | ((color2 >> 8 & 0xFF) * invertedTransparency + (color1 >> 8 & 0xFF) * transparency) // 1 << 8 | ((color2 & 0xFF) * invertedTransparency + (color1 & 0xFF) * transparency) // 1 end]])()else E=function(W,X,Y)local Z=1-Y;local _,a0=W/65536,X/65536;local a1,a2=(W-_*65536)/256,(X-a0*65536)/256;_,a0,a1,a2=_-_%1,a0-a0%1,a1-a1%1,a2-a2%1;local a3,a4,a5=a0*Z+_*Y,a2*Z+a1*Y,(X-a0*65536-a2*256)*Z+(W-_*65536-a1*256)*Y;return(a3-a3%1)*65536+(a4-a4%1)*256+a5-a5%1 end end;local a6,a7,a8,a9;local function aa(ab,ac,...)local ad=ab;local ae=table.pack(...)for af=1,ae.n do ad=ac(ad,ae[af])end;return ad end;if b.getArchitecture and b.getArchitecture()=="Lua 5.3"then a6,a7,a8,a9=load([[local fold = ... return function(...) return fold(0, function(a, b) return a | b end, ...) end,function(...) return fold(0xFFFFFFFF, function(a, b) return a & b end, ...) end,function(x, disp) return (x << disp) & 0xFFFFFFFF end,function(x, disp) return (x >> disp) & 0xFFFFFFFF end]])(aa)else a6,a7,a8,a9=bit32.bor,bit32.band,bit32.lshift,bit32.rshift end;local function ag(ah)local ai={string.byte(ah:read(1))}local aj=0;for af=1,7 do if a7(a9(ai[1],8-af),0x1)==0x0 then aj=af;break end end;for af=1,aj-2 do table.insert(ai,string.byte(ah:read(1)))end;return string.char(table.unpack(ai))end;local function ak(ah,al)local am,ad={string.byte(ah:read(al)or"\x00",1,8)},0;for af=1,#am do ad=a6(a8(ad,8),am[af])end;return ad end;local function an(ao,I,J,ap,aq,ar,as)local at=4*(ao[1]*(J-1)+I)-1;ao[at],ao[at+1],ao[at+2],ao[at+3]=ap,aq,ar,as;return ao end;local function au(ah,ao,av)ao[1]=string.byte(ah:read(1))ao[2]=string.byte(ah:read(1))local aw,ax,ay,az,aA;for ar=1,string.byte(ah:read(1))+av do aw=string.byte(ah:read(1))/255;for as=1,ak(ah,2)+av do ax=ag(ah)for ap=1,string.byte(ah:read(1))+av do ay=U(string.byte(ah:read(1)))for aq=1,string.byte(ah:read(1))+av do az=U(string.byte(ah:read(1)))for J=1,string.byte(ah:read(1))+av do aA=string.byte(ah:read(1))for I=1,string.byte(ah:read(1))+av do an(ao,string.byte(ah:read(1)),aA,ay,az,aw,ax)end end end end end end end;local aB={}aB[5]=function(ah,ao)ao[1]=ak(ah,2)ao[2]=ak(ah,2)for af=1,ao[1]*ao[2]do table.insert(ao,U(string.byte(ah:read(1))))table.insert(ao,U(string.byte(ah:read(1))))table.insert(ao,string.byte(ah:read(1))/255)table.insert(ao,ag(ah))end end;aB[6]=function(ah,ao)au(ah,ao,0)end;aB[7]=function(ah,ao)au(ah,ao,1)end;local function aC(aD)local ah,aE=io.open(aD,"rb")if ah then local aF=ah:read(4)if aF=="OCIF"then local aG=string.byte(ah:read(1))if aB[aG]then local ao={}local ad,aE=xpcall(aB[aG],debug.traceback,ah,ao)ah:close()if ad then return ao else return false,"Failed to load OCIF image: "..tostring(aE)end else ah:close()return false,"Failed to load OCIF image: encoding method \""..tostring(aG).."\" is not supported"end else ah:close()return false,"Failed to load OCIF image: binary signature \""..tostring(aF).."\" is not valid"end else return false,"Failed to open file \""..tostring(aD).."\" for reading: "..tostring(aE)end end;local function aH(aI,aJ)if not aI or not aJ then aI,aJ=p()end;e,f,g,h,i,j={},{},{},{},{},{}c=aI;d=aJ;R()for J=1,d do for I=1,c do C(e,0x010101)C(f,0xFEFEFE)C(g," ")C(h,0x010101)C(i,0xFEFEFE)C(j," ")end end end;local function aK(aI,aJ)q(aI,aJ)aH(aI,aJ)end;local function aL()return c,d end;local function aM()return c end;local function aN()return d end;local function aO(aP,aQ)local aR,aE=o.bind(aP,aQ)if aR then if aQ then aK(o.maxResolution())else aK(c,d)end else return aR,aE end end;local function aS()return o end;local function aT()v=o.get;p=o.getResolution;r=o.getBackground;s=o.getForeground;w=o.set;q=o.setResolution;t=o.setBackground;u=o.setForeground;x=o.fill end;local function aU(aV)o=aV;aT()aH()end;local function aW(aX)if not aX or aX>1 then aX=1 elseif aX<0.1 then aX=0.1 end;local aY,aZ=component.proxy(o.getScreen()).getAspectRatio()local a_,b0=o.maxResolution()local b1=2*(16*aY-4.5)/(16*aZ-4.5)local aJ=aX*math.min(a_/b1,a_,math.sqrt(a_*b0/b1))return math.floor(aJ*b1),math.floor(aJ)end;local function b2(at,ap,aq,as)h[at],i[at],j[at]=ap,aq,as end;local function b3(at)return h[at],i[at],j[at]end;local function b4(I,J)if I>=1 and J>=1 and I<=c and J<=d then local at=c*(J-1)+I;return h[at],i[at],j[at]else return 0x000000,0x000000," "end end;local function b5(I,J,ap,aq,as)if I>=k and J>=m and I<=l and J<=n then local at=c*(J-1)+I;h[at],i[at],j[at]=ap,aq,as end end;local function b6(I,J,aI,aJ,ap,aq,as,Y)local at,b7=c*(J-1)+I,c-aI;for b8=J,J+aJ-1 do if b8>=m and b8<=n then for af=I,I+aI-1 do if af>=k and af<=l then if Y then h[at],i[at]=E(h[at],ap,Y),E(i[at],ap,Y)else h[at],i[at],j[at]=ap,aq,as end end;at=at+1 end;at=at+b7 else at=at+c end end end;local function b9(ba,Y)b6(1,1,c,d,ba or 0x0,0x000000," ",Y)end;local function bb(I,J,aI,aJ)local bc,at={aI,aJ}for b8=J,J+aJ-1 do for af=I,I+aI-1 do if af>=1 and b8>=1 and af<=c and b8<=d then at=c*(b8-1)+af;C(bc,h[at])C(bc,i[at])C(bc,j[at])else C(bc,0x0)C(bc,0x0)C(bc," ")end end end;return bc end;local function bd(be,bf,ao)local bg=ao[1]local bh,bi,bj=c*(bf-1)+be,3,c-bg;for J=bf,bf+ao[2]-1 do if J>=m and J<=n then for I=be,be+bg-1 do if I>=k and I<=l then h[bh]=ao[bi]i[bh]=ao[bi+1]j[bh]=ao[bi+2]end;bh,bi=bh+1,bi+3 end;bh=bh+bj else bh,bi=bh+c,bi+bg*3 end end end;local function bk(N,O,P,Q,bl)local bm,bn,bo,bp,bq,br,bs=N,P,O,Q,false,B(P-N),B(Q-O)if br<bs then bm,bn,bo,bp,bq,br,bs=O,Q,N,P,true,bs,br end;if bo>bp then bo,bp=bp,bo;bm,bn=bn,bm end;local bt,bu,bv=bo,1,br/bs;local bw=bv;for bx=bm,bn,bm<bn and 1 or-1 do if bq then bl(bt,bx)else bl(bx,bt)end;bu=bu+1;if bu>bw then bt,bw=bt+1,bw+bv end end end;local function by(bz,bA,bB,bC,bl)local function bD(bE,bF)bl(bz+bE,bA+bF)bl(bz-bE,bA+bF)bl(bz-bE,bA-bF)bl(bz+bE,bA-bF)end;local I,J,bG,bH,bI,bJ,bK=bB,0,bC*bC*(1-2*bB),bB*bB,0,2*bB*bB,2*bC*bC;local bL,bM=bK*bB,0;while bL>=bM do bD(I,J)J,bM,bI=J+1,bM+bJ,bI+bH;bH=bH+bJ;if 2*bI+bG>0 then I,bL,bI=I-1,bL-bK,bI+bG;bG=bG+bK end end;I,J,bG,bH,bI,bL,bM=0,bC,bC*bC,bB*bB*(1-2*bC),0,0,bJ*bC;while bL<=bM do bD(I,J)I,bL,bI=I+1,bL+bK,bI+bG;bG=bG+bK;if 2*bI+bH>0 then J,bM,bI=J-1,bM-bJ,bI+bH;bH=bH+bJ end end end;local function bN(N,O,P,Q,ap,aq,as)bk(N,O,P,Q,function(I,J)b5(I,J,ap,aq,as)end)end;local function bO(bz,bA,bB,bC,ap,aq,as)by(bz,bA,bB,bC,function(I,J)b5(I,J,ap,aq,as)end)end;local function bP(I,J,bQ,bR,Y)if J>=m and J<=n then local bS,bh=1,c*(J-1)+I;for bS=1,F(bR)do if I>=k and I<=l then if Y then i[bh]=E(h[bh],bQ,Y)else i[bh]=bQ end;j[bh]=G(bR,bS,bS)end;I,bh=I+1,bh+1 end end end;local function bT(be,bf,ao,bU)local bh,bi,bg,ap,aq,ar,as=c*(bf-1)+be,3,ao[1]local bj=c-bg;for J=bf,bf+ao[2]-1 do if J>=m and J<=n then for I=be,be+bg-1 do if I>=k and I<=l then ar,as=ao[bi+2],ao[bi+3]if ar==0 then h[bh],i[bh]=ao[bi],ao[bi+1]elseif ar>0 and ar<1 then h[bh]=E(h[bh],ao[bi],ar)if bU then i[bh]=E(i[bh],ao[bi+1],ar)else i[bh]=ao[bi+1]end elseif as~=" "then i[bh]=ao[bi+1]end;j[bh]=as end;bh,bi=bh+1,bi+4 end;bh=bh+bj else bh,bi=bh+c,bi+bg*4 end end end;local function bV(I,J,aI,aJ,ba)local bW,bX,P="┌"..string.rep("─",aI-2).."┐","└"..string.rep("─",aI-2).."┘",I+aI-1;bP(I,J,ba,bW)J=J+1;for af=1,aJ-2 do bP(I,J,ba,"│")bP(P,J,ba,"│")J=J+1 end;bP(I,J,ba,bX)end;local function bY(at,ba,bZ)local b_,c0,c1="▀","▄"," "local ap,aq,as=h[at],i[at],j[at]if bZ then if as==b_ then if ba==aq then h[at],i[at],j[at]=ba,aq,c1 else h[at],i[at],j[at]=ba,aq,as end elseif as==c1 then if ba~=ap then h[at],i[at],j[at]=ap,ba,c0 end else h[at],i[at],j[at]=ap,ba,c0 end else if as==c0 then if ba==aq then h[at],i[at],j[at]=ba,aq,c1 else h[at],i[at],j[at]=ba,aq,as end elseif as==c1 then if ba~=ap then h[at],i[at],j[at]=ap,ba,b_ end else h[at],i[at],j[at]=ap,ba,b_ end end end;local function c2(I,J,ba)local c3=y(J/2)if I>=k and c3>=m and I<=l and c3<=n then bY(c*(c3-1)+I,ba,J%2==0)end end;local function c4(I,J,aI,aJ,ba)local at,c5,c6,c7,c8=c*(y(J/2)-1)+I,c-aI,aI;for c9=J,J+aJ-1 do c7=y(c9/2)if c7>=m and c7<=n then c8=c9%2==0;for ca=I,I+aI-1 do if ca>=k and ca<=l then bY(at,ba,c8)end;at=at+1 end else at=at+aI end;if c8 then at=at+c5 else at=at-c6 end end end;local function cb(N,O,P,Q,ba)bk(N,O,P,Q,function(I,J)c2(I,J,ba)end)end;local function cc(bz,bA,bB,bC,ba)by(bz,bA,bB,bC,function(I,J)c2(I,J,ba)end)end;local function cd(ce,cf,cg)return{x=ce.x+(cf.x-ce.x)*cg,y=ce.y+(cf.y-ce.y)*cg}end;local function ch(ci,cg)local cj={}for ck=1,#ci-1 do C(cj,cd(ci[ck],ci[ck+1],cg))end;return cj end;local function cl(ci,cg)if#ci>1 then return cl(ch(ci,cg),cg)else return ci[1]end end;local function cm(ci,ba,cn)local co={}for cg=0,1,cn or 0.01 do C(co,cl(ci,cg))end;for ck=1,#co-1 do cb(z(co[ck].x),z(co[ck].y),z(co[ck+1].x),z(co[ck+1].y),ba)end end;local function cp(cq)local at,cr,cs=c*(m-1)+k,c-l+k-1,{}local I,ct,cu,cv,bS,az;local cw,cx,cy,cz,cA;local cB;for J=m,n do I=k;while I<=l do if e[at]~=h[at]or f[at]~=i[at]or g[at]~=j[at]or cq then cw,cx,cy=h[at],i[at],j[at]e[at]=cw;f[at]=cx;g[at]=cy;ct,cu,cv,bS={cy},2,I+1,at+1;while cv<=l do if cw==h[bS]and(j[bS]==" "or cx==i[bS])then e[bS]=h[bS]f[bS]=i[bS]g[bS]=j[bS]ct[cu],cu=g[bS],cu+1 else break end;cv,bS=cv+1,bS+1 end;cs[cw]=cs[cw]or{}cz=cs[cw]cz[cx]=cz[cx]or{index=1}cA=cz[cx]cB=cA.index;cA[cB],cB=I,cB+1;cA[cB],cB=J,cB+1;cA[cB],cB=D(ct),cB+1;I,at,cA.index=I+cu-2,at+cu-2,cB end;I,at=I+1,at+1 end;at=at+cr end;for ap,cC in pairs(cs)do t(ap)for aq,cD in pairs(cC)do if az~=aq then u(aq)az=aq end;for af=1,#cD,3 do w(cD[af],cD[af+1],cD[af+2])end end end;cs=nil end;return{loadImage=aC,getIndex=H,setDrawLimit=M,resetDrawLimit=R,getDrawLimit=S,flush=aH,setResolution=aK,bind=aO,setGPUProxy=aU,getGPUProxy=aS,getScaledResolution=aW,getResolution=aL,getWidth=aM,getHeight=aN,getCurrentFrameTables=K,getNewFrameTables=L,rawSet=b2,rawGet=b3,get=b4,set=b5,clear=b9,copy=bb,paste=bd,rasterizeLine=bk,rasterizeEllipse=by,semiPixelRawSet=bY,semiPixelSet=c2,update=cp,drawRectangle=b6,drawLine=bN,drawEllipse=bO,drawText=bP,drawImage=bT,drawFrame=bV,drawSemiPixelRectangle=c4,drawSemiPixelLine=cb,drawSemiPixelEllipse=cc,drawSemiPixelCurve=cm}